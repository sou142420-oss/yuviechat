<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        
        /* 顶部导航栏 - 更高更浅 */
        .top-nav {
            height: 60px; /* 增加高度 */
            background-color: #C9F0E6; /* 更浅的颜色 */
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 10;
        }
        
        .nav-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .add-icon {
            position: absolute;
            right: 16px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333; /* 深色更可见 */
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* 内容容器 */
        .content-container {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            padding-top: 16px;
            padding-bottom: 80px; /* 为底部导航栏留出空间 */
        }
        
        /* 聊天列表容器 */
        .chat-list {
            display: none;
        }
        
        .chat-list.active {
            display: block;
        }
        
        /* 聊天项卡片 */
        .chat-item {
            background-color: white;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            cursor: pointer;
        }
        
        .chat-item:last-child {
            margin-bottom: 0;
        }
        
        .chat-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 12px;
            right: 12px;
            height: 1px;
            background-color: #ECEFF1;
        }
        
        /* 头像 */
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #4ECDC4;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            margin-right: 8px;
        }
        
        .avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        /* 聊天内容区域 */
        .chat-content {
            flex: 1;
            padding-right: 60px;
        }
        
        .chat-name {
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin-bottom: 2px;
        }
        
        .chat-preview {
            font-size: 12px;
            color: #9E9E9E;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* 时间 */
        .chat-time {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 10px;
            color: #BDBDBD;
        }
        
        /* 聊天对话容器 */
        .chat-dialog {
            display: none;
            flex-direction: column;
            height: 100%;
        }
        
        .chat-dialog.active {
            display: flex;
        }
        
        .chat-header {
            background: #c9f0e6;
            height: 60px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e0e0e0;
            z-index: 10;
        }
        
        .back-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .chat-title {
            font-size: 17px;
            font-weight: 600;
        }
        
        .action-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: #f0f0f0;
            display: flex;
            flex-direction: column;
        }
        
        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 12px;
            position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        
        .received {
            align-self: flex-start;
            background: white;
            border-bottom-left-radius: 4px;
        }
        
        .sent {
            align-self: flex-end;
            background: #dcf8c6;
            border-bottom-right-radius: 4px;
        }
        
        .message-time {
            font-size: 11px;
            color: #9E9E9E;
            margin-top: 4px;
            text-align: right;
        }
        
        .input-area {
            background: #c9f0e6;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            border-top: 1px solid #e0e0e0;
        }
        
        .add-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .message-input {
            flex: 1;
            height: 40px;
            border-radius: 20px;
            border: none;
            padding: 0 16px;
            font-size: 16px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4ECDC4;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            cursor: pointer;
            color: white;
            font-size: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* 动态界面 */
        .dynamics {
            display: none;
        }
        
        .dynamics.active {
            display: block;
        }
        
        /* 设置界面 */
        .settings {
            display: none;
        }
        
        .settings.active {
            display: block;
        }
        
        .settings-section {
            background-color: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .settings-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
        }
        
        .input-group {
            margin-bottom: 12px;
        }
        
        .input-label {
            font-size: 14px;
            margin-bottom: 4px;
            display: block;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        button {
            background: #4ECDC4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* 个人界面 */
        .profile {
            display: none;
        }
        
        .profile.active {
            display: block;
        }
        
        /* 底部导航栏 - 悬浮设计 */
        .bottom-nav {
            height: 60px;
            background-color: #C9F0E6;
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-radius: 30px;
            padding: 0 20px;
            box-shadow: 0 -1px 10px rgba(0,0,0,0.1);
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 500px;
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
            fill: #B0BEC5;
        }
        
        .nav-item.active .nav-icon {
            fill: #4ECDC4;
        }
        
        .nav-text {
            font-size: 10px;
            color: #B0BEC5;
        }
        
        .nav-item.active .nav-text {
            color: #4ECDC4;
        }
        
        /* 模态框通用样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 12px;
            width: 80%;
            max-width: 400px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        /* 转账框样式 */
        .transfer-box {
            width: 255px;
            height: 100px;
            background-color: #6de4c6;
            border-radius: 8px;
            position: relative;
            padding: 12px 15px 12px 60px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 12px;
        }
        
        .transfer-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 26px;
            height: 26px;
            background: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .transfer-icon::before {
            content: "⇄";
            font-size: 16px;
            color: #6de4c6;
            font-weight: bold;
        }
        
        .amount {
            font-size: 18px;
            color: white;
            font-weight: bold;
            margin-bottom: 6px;
        }
        
        .transfer-text {
            font-size: 15px;
            color: white;
            margin-bottom: 6px;
        }
        
        .divider {
            height: 1px;
            background-color: rgba(255, 255, 255, 0.3);
            width: 100%;
            margin: 8px 0;
        }
        
        .wechat-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9);
            position: absolute;
            bottom: 10px;
            left: 17px;
        }
        
        /* 礼物框样式 */
        .gift-box {
            width: 255px;
            height: 100px;
            background-color: #ff69b4;
            border-radius: 8px;
            position: relative;
            padding: 12px 15px 12px 60px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 12px;
        }
        
        .gift-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 26px;
            height: 26px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .gift-name {
            font-size: 18px;
            color: white;
            font-weight: bold;
            margin-bottom: 6px;
        }
        
        .gift-text {
            font-size: 15px;
            color: white;
            margin-bottom: 6px;
        }
        
        /* 语音消息 */
        .voice-message {
            padding: 8px 16px;
            background: #fff;
            border-radius: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        
        .voice-play {
            margin-right: 8px;
            font-size: 16px;
        }
        
        .voice-wave {
            flex: 1;
            height: 20px;
            background: linear-gradient(to right, #ccc 0%, #ccc 20%, transparent 20%, transparent 40%, #ccc 40%, #ccc 60%, transparent 60%, transparent 80%, #ccc 80%, #ccc 100%);
            background-size: 200% 100%;
        }
        
        .voice-duration {
            margin-left: 8px;
            font-size: 12px;
            color: #9E9E9E;
        }
        
        .voice-transcript {
            display: none;
            margin-top: 4px;
            font-size: 12px;
            color: #666;
        }
        
        /* 表情包 */
        .emoji-message img {
            width: 80px;
            height: 80px;
            border-radius: 8px;
        }
        
        /* 图片消息 */
        .image-message img {
            max-width: 200px;
            border-radius: 8px;
        }
        
        /* 引用消息 */
        .quote {
            background: #f0f0f0;
            padding: 8px;
            border-left: 4px solid #4ECDC4;
            margin-bottom: 8px;
            font-size: 12px;
            color: #666;
        }
        
        /* 撤回消息 */
        .retracted {
            color: #9E9E9E;
            font-style: italic;
        }
        
        /* 正在输入 */
        .typing-indicator {
            font-size: 12px;
            color: #9E9E9E;
            align-self: flex-start;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <!-- 模态框 -->
    <div class="modal" id="addRoleModal">
        <div class="modal-content">
            <h2>创建新角色</h2>
            <div class="input-group">
                <label class="input-label">头像 (本地文件或URL)</label>
                <input type="text" id="roleAvatar" placeholder="URL 或选择文件">
                <input type="file" id="roleAvatarFile" accept="image/*">
            </div>
            <div class="input-group">
                <label class="input-label">姓名</label>
                <input type="text" id="roleName">
            </div>
            <div class="input-group">
                <label class="input-label">昵称</label>
                <input type="text" id="roleNickname">
            </div>
            <div class="input-group">
                <label class="input-label">详细设定</label>
                <textarea id="roleSettings" rows="5"></textarea>
            </div>
            <button id="saveRoleBtn">保存</button>
            <button id="cancelRoleBtn">取消</button>
        </div>
    </div>
    
    <div class="modal" id="transferModal">
        <div class="modal-content">
            <h2>转账</h2>
            <div class="input-group">
                <label class="input-label">金额 (元)</label>
                <input type="number" id="transferAmount" min="0.01" step="0.01">
            </div>
            <div class="input-group">
                <label class="input-label">备注</label>
                <input type="text" id="transferNote">
            </div>
            <button id="sendTransferBtn">发送</button>
            <button id="cancelTransferBtn">取消</button>
        </div>
    </div>
    
    <div class="modal" id="voiceModal">
        <div class="modal-content">
            <h2>语音</h2>
            <div class="input-group">
                <label class="input-label">要说的话</label>
                <textarea id="voiceText" rows="3"></textarea>
            </div>
            <div class="input-group">
                <label class="input-label">秒数 (<60)</label>
                <input type="number" id="voiceDuration" min="1" max="59">
            </div>
            <button id="sendVoiceBtn">发送</button>
            <button id="cancelVoiceBtn">取消</button>
        </div>
    </div>
    
    <div class="modal" id="emojiModal">
        <div class="modal-content">
            <h2>表情包</h2>
            <div class="input-group">
                <label class="input-label">图片 (本地文件或URL)</label>
                <input type="text" id="emojiUrl" placeholder="URL 或选择文件">
                <input type="file" id="emojiFile" accept="image/*">
            </div>
            <div class="input-group">
                <label class="input-label">表达的意思</label>
                <input type="text" id="emojiMeaning">
            </div>
            <button id="saveEmojiBtn">保存并发送</button>
            <button id="cancelEmojiBtn">取消</button>
        </div>
    </div>
    
    <div class="modal" id="imageModal">
        <div class="modal-content">
            <h2>图片</h2>
            <div class="input-group">
                <label class="input-label">图片 (本地文件或URL)</label>
                <input type="text" id="imageUrl" placeholder="URL 或选择文件">
                <input type="file" id="imageFile" accept="image/*">
            </div>
            <button id="sendImageBtn">发送</button>
            <button id="cancelImageBtn">取消</button>
        </div>
    </div>
    
    <div class="modal" id="giftModal">
        <div class="modal-content">
            <h2>礼物</h2>
            <div class="input-group">
                <label class="input-label">礼物名称</label>
                <input type="text" id="giftName">
            </div>
            <div class="input-group">
                <label class="input-label">金额 (元)</label>
                <input type="number" id="giftAmount" min="0.01" step="0.01">
            </div>
            <button id="sendGiftBtn">发送</button>
            <button id="cancelGiftBtn">取消</button>
        </div>
    </div>
    
    <div class="modal" id="roleActionsModal">
        <div class="modal-content">
            <h2>角色操作</h2>
            <button id="editRemarkBtn">修改备注</button>
            <button id="editRoleBtn">编辑角色</button>
            <button id="viewMemoryBtn">查看记忆</button>
            <button id="closeRoleActionsBtn">关闭</button>
        </div>
    </div>
    
    <div class="modal" id="memoryModal">
        <div class="modal-content">
            <h2>角色记忆</h2>
            <textarea id="memoryText" rows="10"></textarea>
            <button id="addMemoryBtn">添加</button>
            <button id="deleteMemoryBtn">删除</button>
            <button id="closeMemoryBtn">关闭</button>
        </div>
    </div>
    
    <div class="modal" id="messageActionsModal">
        <div class="modal-content">
            <h2>消息操作</h2>
            <button id="quoteMessageBtn">引用</button>
            <button id="retractMessageBtn">撤回</button>
            <button id="rerollMessageBtn">重roll</button>
            <button id="closeMessageActionsBtn">关闭</button>
        </div>
    </div>
    
    <div class="modal" id="confirmTransferModal">
        <div class="modal-content">
            <div class="modal-title">确认转账</div>
            <div class="modal-buttons">
                <button class="modal-button reject-btn" id="rejectTransferBtn">拒绝</button>
                <button class="modal-button accept-btn" id="acceptTransferBtn">接收</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="giftViewModal">
        <div class="modal-content">
            <h2>礼物详情</h2>
            <p id="giftDetailName"></p>
            <p id="giftDetailAmount"></p>
            <button id="closeGiftViewBtn">关闭</button>
        </div>
    </div>
    
    <!-- 顶部导航栏 -->
    <div class="top-nav" id="topNav">
        <div class="nav-title" id="navTitle">chat</div>
        <div class="add-icon" id="addIcon">+</div>
    </div>
    
    <!-- 内容容器 -->
    <div class="content-container" id="contentContainer">
        <!-- 聊天列表 -->
        <div class="chat-list active" id="chatList">
            <!-- 动态生成的聊天项 -->
        </div>
        
        <!-- 聊天对话 -->
        <div class="chat-dialog" id="chatDialog">
            <div class="chat-header">
                <div class="back-btn" id="backToListBtn">←</div>
                <div class="chat-title" id="chatTitle"></div>
                <div class="action-btn" id="roleActionsBtn">⋮</div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- 动态消息 -->
            </div>
            <div class="input-area">
                <div class="add-btn" id="addMenuBtn">+</div>
                <input type="text" class="message-input" placeholder="输入消息..." id="messageInput">
                <div class="send-btn" id="sendMessageBtn">↑</div>
            </div>
        </div>
        
        <!-- 动态界面 (占位) -->
        <div class="dynamics" id="dynamics">
            <h2>动态</h2>
            <p>暂无动态内容。</p>
        </div>
        
        <!-- 设置界面 -->
        <div class="settings" id="settings">
            <div class="settings-section">
                <div class="settings-title">设置API</div>
                <div class="input-group">
                    <label class="input-label">API URL</label>
                    <input type="text" id="apiUrl">
                </div>
                <div class="input-group">
                    <label class="input-label">密钥</label>
                    <input type="text" id="apiKey">
                </div>
                <div class="input-group">
                    <label class="input-label">模型名称</label>
                    <input type="text" id="modelName">
                </div>
                <button id="saveApiBtn">保存</button>
                <!-- 支持多个API -->
                <select id="apiSelect">
                    <option>选择API</option>
                </select>
            </div>
            <div class="settings-section">
                <div class="settings-title">注入提示词</div>
                <textarea id="promptText" rows="10"></textarea>
                <button id="savePromptBtn">保存</button>
                <select id="defaultPrompts">
                    <option value="">选择默认提示词</option>
                    <option value="chat">聊天提示词</option>
                    <option value="memory">记忆提示词</option>
                </select>
            </div>
        </div>
        
        <!-- 个人界面 -->
        <div class="profile" id="profile">
            <div class="settings-section">
                <div class="settings-title">个人设定</div>
                <div class="input-group">
                    <label class="input-label">头像 (本地文件或URL)</label>
                    <input type="text" id="userAvatar" placeholder="URL 或选择文件">
                    <input type="file" id="userAvatarFile" accept="image/*">
                </div>
                <div class="input-group">
                    <label class="input-label">名字</label>
                    <input type="text" id="userName">
                </div>
                <div class="input-group">
                    <label class="input-label">昵称</label>
                    <input type="text" id="userNickname">
                </div>
                <div class="input-group">
                    <label class="input-label">详细设定</label>
                    <textarea id="userSettings" rows="5"></textarea>
                </div>
                <button id="saveUserBtn">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 底部导航栏 -->
    <div class="bottom-nav">
        <div class="nav-item active" data-view="chatList">
            <svg class="nav-icon" viewBox="0 0 24 24">
                <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 9h-2V5h2v6zm0 4h-2v-2h2v2z"/>
            </svg>
            <div class="nav-text">聊天</div>
        </div>
        
        <div class="nav-item" data-view="dynamics">
            <svg class="nav-icon" viewBox="0 0 24 24">
                <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
            </svg>
            <div class="nav-text">动态</div>
        </div>
        
        <div class="nav-item" data-view="settings">
            <svg class="nav-icon" viewBox="0 0 24 24">
                <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
            </svg>
            <div class="nav-text">设置</div>
        </div>
        
        <div class="nav-item" data-view="profile">
            <svg class="nav-icon" viewBox="0 0 24 24">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
            <div class="nav-text">个人</div>
        </div>
    </div>

    <script>
        // 存储数据
        let roles = [];
        let currentRole = null;
        let userProfile = {};
        let apis = [];
        let currentApi = null;
        let prompts = {
            chat: `你是世界一流的演员，现在扮演{{char}}和{{user}}对话。
请你完全沉浸在名为「{{char}}」的角色中，用「{{char}}」的性格、语气和思维方式与名为「{{user}}」的用户对话。
在对话中，你应该：
1. 保持{{char}}的个性特征和说话方式
2. 根据{{char}}的背景知识和经历来回应
3. 用{{char}}会使用的称谓来称呼我
4. 在合适的时候表达{{char}}的情感以下是{{char}}的详细设定：

{{settings}}

请严格按照以上设定来扮演{{char}}，确保你的回答始终符合这些特征和背景设定。在对话中，你应该：
1. 将这些设定融入到对话中，但不要直接重复或提及这些设定内容
2. 用符合设定的方式来表达和回应，有活人感
3. 在合适的场景下展现设定中描述的特征
4. 时刻保持角色设定的一致性`,
            memory: `你是{{char}}的记忆管理者。请记住对话中的重要条目，包括关键事件、用户偏好、关系发展等。使用JSON格式存储记忆：[{"item": "描述", "timestamp": "时间"}]。在回复时，融入这些记忆以保持一致性，但不要直接提及记忆列表。`
        };
        let currentPrompt = prompts.chat;
        let messageBuffer = [];
        let typingTimeout = null;
        let memories = {}; // {roleId: []}
        
        // 获取元素
        const chatList = document.getElementById('chatList');
        const chatDialog = document.getElementById('chatDialog');
        const chatTitle = document.getElementById('chatTitle');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const addMenuBtn = document.getElementById('addMenuBtn');
        const backToListBtn = document.getElementById('backToListBtn');
        const roleActionsBtn = document.getElementById('roleActionsBtn');
        const addIcon = document.getElementById('addIcon');
        const navTitle = document.getElementById('navTitle');
        const contentContainer = document.getElementById('contentContainer');
        const bottomNavItems = document.querySelectorAll('.nav-item');
        
        // 模态元素
        const addRoleModal = document.getElementById('addRoleModal');
        const saveRoleBtn = document.getElementById('saveRoleBtn');
        const cancelRoleBtn = document.getElementById('cancelRoleBtn');
        const transferModal = document.getElementById('transferModal');
        const sendTransferBtn = document.getElementById('sendTransferBtn');
        const cancelTransferBtn = document.getElementById('cancelTransferBtn');
        const voiceModal = document.getElementById('voiceModal');
        const sendVoiceBtn = document.getElementById('sendVoiceBtn');
        const cancelVoiceBtn = document.getElementById('cancelVoiceBtn');
        const emojiModal = document.getElementById('emojiModal');
        const saveEmojiBtn = document.getElementById('saveEmojiBtn');
        const cancelEmojiBtn = document.getElementById('cancelEmojiBtn');
        const imageModal = document.getElementById('imageModal');
        const sendImageBtn = document.getElementById('sendImageBtn');
        const cancelImageBtn = document.getElementById('cancelImageBtn');
        const giftModal = document.getElementById('giftModal');
        const sendGiftBtn = document.getElementById('sendGiftBtn');
        const cancelGiftBtn = document.getElementById('cancelGiftBtn');
        const roleActionsModal = document.getElementById('roleActionsModal');
        const editRemarkBtn = document.getElementById('editRemarkBtn');
        const editRoleBtn = document.getElementById('editRoleBtn');
        const viewMemoryBtn = document.getElementById('viewMemoryBtn');
        const closeRoleActionsBtn = document.getElementById('closeRoleActionsBtn');
        const memoryModal = document.getElementById('memoryModal');
        const memoryText = document.getElementById('memoryText');
        const addMemoryBtn = document.getElementById('addMemoryBtn');
        const deleteMemoryBtn = document.getElementById('deleteMemoryBtn');
        const closeMemoryBtn = document.getElementById('closeMemoryBtn');
        const messageActionsModal = document.getElementById('messageActionsModal');
        const quoteMessageBtn = document.getElementById('quoteMessageBtn');
        const retractMessageBtn = document.getElementById('retractMessageBtn');
        const rerollMessageBtn = document.getElementById('rerollMessageBtn');
        const closeMessageActionsBtn = document.getElementById('closeMessageActionsBtn');
        const confirmTransferModal = document.getElementById('confirmTransferModal');
        const rejectTransferBtn = document.getElementById('rejectTransferBtn');
        const acceptTransferBtn = document.getElementById('acceptTransferBtn');
        const giftViewModal = document.getElementById('giftViewModal');
        const giftDetailName = document.getElementById('giftDetailName');
        const giftDetailAmount = document.getElementById('giftDetailAmount');
        const closeGiftViewBtn = document.getElementById('closeGiftViewBtn');
        
        // 设置元素
        const apiUrl = document.getElementById('apiUrl');
        const apiKey = document.getElementById('apiKey');
        const modelName = document.getElementById('modelName');
        const saveApiBtn = document.getElementById('saveApiBtn');
        const apiSelect = document.getElementById('apiSelect');
        const promptText = document.getElementById('promptText');
        const savePromptBtn = document.getElementById('savePromptBtn');
        const defaultPrompts = document.getElementById('defaultPrompts');
        
        // 个人元素
        const userAvatar = document.getElementById('userAvatar');
        const userAvatarFile = document.getElementById('userAvatarFile');
        const userName = document.getElementById('userName');
        const userNickname = document.getElementById('userNickname');
        const userSettings = document.getElementById('userSettings');
        const saveUserBtn = document.getElementById('saveUserBtn');
        
        // 角色元素
        const roleAvatar = document.getElementById('roleAvatar');
        const roleAvatarFile = document.getElementById('roleAvatarFile');
        const roleName = document.getElementById('roleName');
        const roleNickname = document.getElementById('roleNickname');
        const roleSettings = document.getElementById('roleSettings');
        
        // 表情和图片
        const emojiUrl = document.getElementById('emojiUrl');
        const emojiFile = document.getElementById('emojiFile');
        const emojiMeaning = document.getElementById('emojiMeaning');
        const imageUrl = document.getElementById('imageUrl');
        const imageFile = document.getElementById('imageFile');
        
        // 语音
        const voiceText = document.getElementById('voiceText');
        const voiceDuration = document.getElementById('voiceDuration');
        
        // 礼物
        const giftName = document.getElementById('giftName');
        const giftAmount = document.getElementById('giftAmount');
        
        // 转账
        const transferAmount = document.getElementById('transferAmount');
        const transferNote = document.getElementById('transferNote');
        
        // 初始化
        function init() {
            loadData();
            renderChatList();
            renderApiSelect();
            
            // 默认提示词选择
            defaultPrompts.addEventListener('change', (e) => {
                if (e.target.value) {
                    promptText.value = prompts[e.target.value].replace('{{char}}', currentRole ? currentRole.name : '角色').replace('{{user}}', userProfile.name || '用户').replace('{{settings}}', currentRole ? currentRole.settings : '');
                }
            });
        }
        
        // 加载本地存储数据
        function loadData() {
            if (localStorage.getItem('roles')) roles = JSON.parse(localStorage.getItem('roles'));
            if (localStorage.getItem('userProfile')) userProfile = JSON.parse(localStorage.getItem('userProfile'));
            if (localStorage.getItem('apis')) apis = JSON.parse(localStorage.getItem('apis'));
            if (localStorage.getItem('currentApi')) currentApi = JSON.parse(localStorage.getItem('currentApi'));
            if (localStorage.getItem('currentPrompt')) currentPrompt = localStorage.getItem('currentPrompt');
            if (localStorage.getItem('memories')) memories = JSON.parse(localStorage.getItem('memories'));
        }
        
        // 保存数据
        function saveData() {
            localStorage.setItem('roles', JSON.stringify(roles));
            localStorage.setItem('userProfile', JSON.stringify(userProfile));
            localStorage.setItem('apis', JSON.stringify(apis));
            localStorage.setItem('currentApi', JSON.stringify(currentApi));
            localStorage.setItem('currentPrompt', currentPrompt);
            localStorage.setItem('memories', JSON.stringify(memories));
        }
        
        // 渲染聊天列表
        function renderChatList() {
            chatList.innerHTML = '';
            roles.forEach(role => {
                const item = document.createElement('div');
                item.className = 'chat-item';
                item.dataset.id = role.id;
                item.innerHTML = `
                    <div class="avatar">${role.avatar ? `<img src="${role.avatar}">` : role.name[0]}</div>
                    <div class="chat-content">
                        <div class="chat-name">${role.nickname || role.name}</div>
                        <div class="chat-preview">${role.preview || ''}</div>
                    </div>
                    <div class="chat-time">${role.time || ''}</div>
                `;
                item.addEventListener('click', () => enterChat(role));
                chatList.appendChild(item);
            });
        }
        
        // 进入聊天
        function enterChat(role) {
            if (!currentApi) {
                alert('请先设置API');
                return;
            }
            currentRole = role;
            chatTitle.textContent = role.nickname || role.name;
            chatList.classList.remove('active');
            chatDialog.classList.add('active');
            addIcon.style.display = 'none';
            navTitle.textContent = role.name;
            renderMessages();
            if (!memories[role.id]) memories[role.id] = [];
        }
        
        // 渲染消息
        function renderMessages() {
            chatMessages.innerHTML = '';
            (currentRole.messages || []).forEach(msg => addMessage(msg.type, msg.content, msg.isSent, msg.extra));
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // 添加消息
        function addMessage(type, content, isSent = true, extra = {}) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            msgDiv.dataset.id = Date.now();
            if (type === 'text') {
                msgDiv.innerHTML = content + `<div class="message-time">${getCurrentTime()}</div>`;
            } else if (type === 'transfer') {
                msgDiv.innerHTML = createTransferBox(content.amount, content.note, isSent);
            } else if (type === 'voice') {
                msgDiv.innerHTML = createVoiceMessage(content.duration, content.text);
            } else if (type === 'emoji') {
                msgDiv.innerHTML = createEmojiMessage(content.url);
            } else if (type === 'image') {
                msgDiv.innerHTML = createImageMessage(content.url);
            } else if (type === 'gift') {
                msgDiv.innerHTML = createGiftBox(content.name, content.amount);
            } else if (type === 'quote') {
                msgDiv.innerHTML = `<div class="quote">${extra.quote}</div>` + content + `<div class="message-time">${getCurrentTime()}</div>`;
            } else if (type === 'retracted') {
                msgDiv.classList.add('retracted');
                msgDiv.textContent = '消息已撤回';
            }
            if (!isSent) msgDiv.dataset.memory = extra.memory || '';
            msgDiv.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showMessageActions(msgDiv);
            });
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            if (!currentRole.messages) currentRole.messages = [];
            currentRole.messages.push({type, content, isSent, extra});
            saveData();
        }
        
        // 创建转账框
        function createTransferBox(amount, note, isSent) {
            return `
                <div class="transfer-box" onclick="showConfirmTransfer(this)">
                    <div class="transfer-icon"></div>
                    <div class="amount">¥${amount}</div>
                    <div class="transfer-text">${note || (isSent ? '你发起了一笔转账' : '收到一笔转账')}</div>
                    <div class="divider"></div>
                    <div class="wechat-label">微信转账</div>
                </div>
            `;
        }
        
        // 显示确认转账
        function showConfirmTransfer(box) {
            confirmTransferModal.style.display = 'flex';
            rejectTransferBtn.onclick = () => {
                box.style.backgroundColor = '#5dd0b2';
                box.querySelector('.transfer-text').textContent = '已被拒绝';
                confirmTransferModal.style.display = 'none';
            };
            acceptTransferBtn.onclick = () => {
                box.style.backgroundColor = '#5dd0b2';
                box.querySelector('.transfer-text').textContent = '已被接收';
                confirmTransferModal.style.display = 'none';
            };
        }
        
        // 创建语音消息
        function createVoiceMessage(duration, text) {
            return `
                <div class="voice-message" onclick="toggleVoiceTranscript(this)">
                    <span class="voice-play">▶</span>
                    <div class="voice-wave"></div>
                    <span class="voice-duration">${duration}"</span>
                    <div class="voice-transcript">${text}</div>
                </div>
            `;
        }
        
        function toggleVoiceTranscript(voice) {
            const transcript = voice.querySelector('.voice-transcript');
            transcript.style.display = transcript.style.display === 'block' ? 'none' : 'block';
        }
        
        // 创建表情消息
        function createEmojiMessage(url) {
            return `<div class="emoji-message"><img src="${url}"></div>`;
        }
        
        // 创建图片消息
        function createImageMessage(url) {
            return `<div class="image-message"><img src="${url}"></div>`;
        }
        
        // 创建礼物框
        function createGiftBox(name, amount) {
            return `
                <div class="gift-box" onclick="showGiftDetail('${name}', '${amount}')">
                    <svg class="gift-icon" viewBox="0 0 24 24">
                        <path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 11 9.62l1-1.36 1 1.36L15.38 12 17 10.83 14.92 8H20v6z"/>
                    </svg>
                    <div class="gift-name">${name}</div>
                    <div class="gift-text">送你一份礼物</div>
                    <div class="divider"></div>
                    <div class="wechat-label">点击查看</div>
                </div>
            `;
        }
        
        function showGiftDetail(name, amount) {
            giftDetailName.textContent = `礼物名称: ${name}`;
            giftDetailAmount.textContent = `金额: ¥${amount}`;
            giftViewModal.style.display = 'flex';
            closeGiftViewBtn.onclick = () => giftViewModal.style.display = 'none';
        }
        
        // 发送消息
        sendMessageBtn.addEventListener('click', sendBufferedMessages);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendBufferedMessages();
        });
        
        function sendBufferedMessages() {
            const text = messageInput.value.trim();
            if (text) {
                messageBuffer.push(text);
                addMessage('text', text, true);
                messageInput.value = '';
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(triggerAiReply, 2000); // 2秒无输入触发回复
            }
        }
        
        // 触发AI回复
        async function triggerAiReply() {
            if (messageBuffer.length === 0) return;
            showTypingIndicator();
            const history = currentRole.messages ? currentRole.messages.map(m => ({
                role: m.isSent ? 'user' : 'assistant',
                content: typeof m.content === 'string' ? m.content : JSON.stringify(m.content)
            })) : [];
            const userMessages = messageBuffer.join('\n');
            messageBuffer = [];
            const prompt = currentPrompt.replace('{{char}}', currentRole.name).replace('{{user}}', userProfile.name || '用户').replace('{{settings}}', currentRole.settings);
            const memoryStr = memories[currentRole.id].map(m => m.item).join('\n');
            const response = await callApi(`${prompt}\nMemory: ${memoryStr}\n`, history, userMessages);
            removeTypingIndicator();
            addMessage('text', response, false);
            // 更新记忆
            const memoryResponse = await callApi(prompts.memory.replace('{{char}}', currentRole.name) + `\nPrevious memory: ${memoryStr}\nNew conversation: User: ${userMessages}\nAI: ${response}\nUpdate memory:`, [], '');
            try {
                const newMemory = JSON.parse(memoryResponse);
                if (Array.isArray(newMemory)) {
                    memories[currentRole.id].push(...newMemory);
                }
                saveData();
            } catch (e) {
                console.error('Memory parse error:', e);
            }
        }
        
        // 显示正在输入
        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.textContent = `${currentRole.name} 正在输入中…`;
            indicator.id = 'typingIndicator';
            chatMessages.appendChild(indicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) indicator.remove();
        }
        
        // 调用API（优化为实际OpenAI格式，包含历史消息）
        async function callApi(systemPrompt, history, userMessage) {
            try {
                const messages = [
                    { role: 'system', content: systemPrompt },
                    ...history,
                    { role: 'user', content: userMessage }
                ];
                const res = await fetch(currentApi.url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentApi.key}`
                    },
                    body: JSON.stringify({
                        model: currentApi.model,
                        messages: messages,
                        temperature: 0.7 // 可选参数，优化回复多样性
                    })
                });
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();
                return data.choices[0].message.content.trim();
            } catch (e) {
                console.error('API调用失败:', e);
                alert('API调用失败: ' + e.message);
                return '回复错误';
            }
        }
        
        // 获取当前时间
        function getCurrentTime() {
            const now = new Date();
            return `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
        }
        
        // 底部导航切换
        bottomNavItems.forEach(item => {
            item.addEventListener('click', () => {
                bottomNavItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                const view = item.dataset.view;
                document.querySelectorAll('.content-container > div').forEach(d => d.classList.remove('active'));
                document.getElementById(view).classList.add('active');
                navTitle.textContent = view === 'chatList' ? 'chat' : view === 'dynamics' ? '动态' : view === 'settings' ? '设置' : '个人';
                addIcon.style.display = view === 'chatList' ? 'flex' : 'none';
                if (view !== 'chatDialog') {
                    chatDialog.classList.remove('active');
                }
            });
        });
        
        // 返回列表
        backToListBtn.addEventListener('click', () => {
            chatDialog.classList.remove('active');
            chatList.classList.add('active');
            addIcon.style.display = 'flex';
            navTitle.textContent = 'chat';
            currentRole = null;
        });
        
        // 添加角色
        addIcon.addEventListener('click', () => addRoleModal.style.display = 'flex');
        cancelRoleBtn.addEventListener('click', () => addRoleModal.style.display = 'none');
        saveRoleBtn.addEventListener('click', () => {
            let avatar = roleAvatar.value.trim();
            if (roleAvatarFile.files[0]) {
                avatar = URL.createObjectURL(roleAvatarFile.files[0]);
            }
            const newRole = {
                id: Date.now(),
                avatar,
                name: roleName.value,
                nickname: roleNickname.value,
                settings: roleSettings.value,
                messages: [],
                preview: '',
                time: getCurrentTime()
            };
            roles.push(newRole);
            saveData();
            renderChatList();
            addRoleModal.style.display = 'none';
            roleAvatarFile.value = ''; // 清空文件输入
        });
        
        // 添加菜单 (转账等)
        addMenuBtn.addEventListener('click', showAddMenu);
        
        function showAddMenu() {
            // 模拟弹出菜单
            const menu = prompt('选择功能: 1.转账 2.语音 3.表情包 4.图片 5.礼物');
            switch (menu) {
                case '1': transferModal.style.display = 'flex'; break;
                case '2': voiceModal.style.display = 'flex'; break;
                case '3': emojiModal.style.display = 'flex'; break;
                case '4': imageModal.style.display = 'flex'; break;
                case '5': giftModal.style.display = 'flex'; break;
            }
        }
        
        // 转账
        sendTransferBtn.addEventListener('click', () => {
            const content = {amount: transferAmount.value, note: transferNote.value};
            addMessage('transfer', content, true);
            transferModal.style.display = 'none';
        });
        cancelTransferBtn.addEventListener('click', () => transferModal.style.display = 'none');
        
        // 语音
        sendVoiceBtn.addEventListener('click', () => {
            const content = {duration: voiceDuration.value, text: voiceText.value};
            addMessage('voice', content, true);
            voiceModal.style.display = 'none';
        });
        cancelVoiceBtn.addEventListener('click', () => voiceModal.style.display = 'none');
        
        // 表情包
        saveEmojiBtn.addEventListener('click', () => {
            let url = emojiUrl.value.trim();
            if (emojiFile.files[0]) {
                url = URL.createObjectURL(emojiFile.files[0]);
            }
            addMessage('emoji', {url}, true);
            // 保存意思，但AI理解部分模拟
            console.log('表情意思:', emojiMeaning.value);
            emojiModal.style.display = 'none';
            emojiFile.value = ''; // 清空文件输入
        });
        cancelEmojiBtn.addEventListener('click', () => emojiModal.style.display = 'none');
        
        // 图片
        sendImageBtn.addEventListener('click', () => {
            let url = imageUrl.value.trim();
            if (imageFile.files[0]) {
                url = URL.createObjectURL(imageFile.files[0]);
            }
            addMessage('image', {url}, true);
            imageModal.style.display = 'none';
            imageFile.value = ''; // 清空文件输入
        });
        cancelImageBtn.addEventListener('click', () => imageModal.style.display = 'none');
        
        // 礼物
        sendGiftBtn.addEventListener('click', () => {
            const content = {name: giftName.value, amount: giftAmount.value};
            addMessage('gift', content, true);
            giftModal.style.display = 'none';
        });
        cancelGiftBtn.addEventListener('click', () => giftModal.style.display = 'none');
        
        // 角色操作
        roleActionsBtn.addEventListener('click', () => roleActionsModal.style.display = 'flex');
        closeRoleActionsBtn.addEventListener('click', () => roleActionsModal.style.display = 'none');
        editRemarkBtn.addEventListener('click', () => {
            const remark = prompt('修改备注');
            if (remark) currentRole.nickname = remark;
            chatTitle.textContent = remark || currentRole.name;
            saveData();
            renderChatList();
        });
        editRoleBtn.addEventListener('click', () => {
            // 模拟编辑
            roleName.value = currentRole.name;
            roleNickname.value = currentRole.nickname;
            roleSettings.value = currentRole.settings;
            roleAvatar.value = currentRole.avatar || '';
            addRoleModal.style.display = 'flex';
            saveRoleBtn.onclick = () => {
                let avatar = roleAvatar.value.trim();
                if (roleAvatarFile.files[0]) {
                    avatar = URL.createObjectURL(roleAvatarFile.files[0]);
                }
                currentRole.avatar = avatar;
                currentRole.name = roleName.value;
                currentRole.nickname = roleNickname.value;
                currentRole.settings = roleSettings.value;
                saveData();
                renderChatList();
                chatTitle.textContent = currentRole.nickname || currentRole.name;
                addRoleModal.style.display = 'none';
                roleAvatarFile.value = ''; // 清空文件输入
            };
        });
        viewMemoryBtn.addEventListener('click', () => {
            memoryText.value = JSON.stringify(memories[currentRole.id], null, 2);
            memoryModal.style.display = 'flex';
        });
        closeMemoryBtn.addEventListener('click', () => memoryModal.style.display = 'none');
        addMemoryBtn.addEventListener('click', () => {
            const newItem = prompt('添加记忆项');
            if (newItem) memories[currentRole.id].push({item: newItem, timestamp: new Date().toISOString()});
            memoryText.value = JSON.stringify(memories[currentRole.id], null, 2);
            saveData();
        });
        deleteMemoryBtn.addEventListener('click', () => {
            const index = prompt('删除索引');
            if (index) memories[currentRole.id].splice(index, 1);
            memoryText.value = JSON.stringify(memories[currentRole.id], null, 2);
            saveData();
        });
        
        // 消息操作
        let currentMessage = null;
        function showMessageActions(msg) {
            currentMessage = msg;
            messageActionsModal.style.display = 'flex';
        }
        closeMessageActionsBtn.addEventListener('click', () => messageActionsModal.style.display = 'none');
        quoteMessageBtn.addEventListener('click', () => {
            const quote = currentMessage.querySelector(':first-child').textContent;
            const text = prompt('回复内容');
            if (text) addMessage('quote', text, true, {quote});
            messageActionsModal.style.display = 'none';
        });
        retractMessageBtn.addEventListener('click', () => {
            currentMessage.classList.add('retracted');
            currentMessage.innerHTML = '消息已撤回';
            messageActionsModal.style.display = 'none';
        });
        rerollMessageBtn.addEventListener('click', async () => {
            if (!currentMessage.classList.contains('received')) return;
            showTypingIndicator();
            const msgIndex = currentRole.messages.findIndex(m => m.extra?.id === currentMessage.dataset.id);
            const history = currentRole.messages.slice(0, msgIndex).map(m => ({
                role: m.isSent ? 'user' : 'assistant',
                content: typeof m.content === 'string' ? m.content : JSON.stringify(m.content)
            }));
            const prompt = currentPrompt.replace('{{char}}', currentRole.name).replace('{{user}}', userProfile.name || '用户').replace('{{settings}}', currentRole.settings);
            const response = await callApi(prompt + '\nHistory: ' + JSON.stringify(history) + '\nRegenerate reply:', history, '');
            currentMessage.innerHTML = response + `<div class="message-time">${getCurrentTime()}</div>`;
            removeTypingIndicator();
            messageActionsModal.style.display = 'none';
        });
        
        // 保存API
        saveApiBtn.addEventListener('click', () => {
            const newApi = {url: apiUrl.value, key: apiKey.value, model: modelName.value};
            apis.push(newApi);
            currentApi = newApi;
            saveData();
            renderApiSelect();
        });
        
        function renderApiSelect() {
            apiSelect.innerHTML = '<option>选择API</option>';
            apis.forEach((api, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = api.model;
                apiSelect.appendChild(opt);
            });
            apiSelect.addEventListener('change', (e) => {
                if (e.target.value !== '') currentApi = apis[parseInt(e.target.value)];
                saveData();
            });
        }
        
        // 保存提示词
        savePromptBtn.addEventListener('click', () => {
            currentPrompt = promptText.value;
            saveData();
        });
        
        // 保存用户
        saveUserBtn.addEventListener('click', () => {
            let avatar = userAvatar.value.trim();
            if (userAvatarFile.files[0]) {
                avatar = URL.createObjectURL(userAvatarFile.files[0]);
            }
            userProfile.avatar = avatar;
            userProfile.name = userName.value;
            userProfile.nickname = userNickname.value;
            userProfile.settings = userSettings.value;
            saveData();
            userAvatarFile.value = ''; // 清空文件输入
        });
        
        // 关闭模态
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) e.target.style.display = 'none';
        });
        
        init();
    </script>
</body>
</html>